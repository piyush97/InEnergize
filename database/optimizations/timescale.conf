# TimescaleDB Performance Optimization Configuration
# Optimized for InErgize Analytics Service - High-throughput time-series data

# Include base PostgreSQL optimizations
include '/etc/postgresql/postgresql.conf'

# TimescaleDB Specific Settings
shared_preload_libraries = 'timescaledb,pg_stat_statements'
timescaledb.telemetry_level = off
timescaledb.max_background_workers = 16

# Enhanced Memory Settings for Time-Series
shared_buffers = 4GB
effective_cache_size = 12GB
work_mem = 64MB
maintenance_work_mem = 1GB
max_connections = 400

# WAL Settings for High Write Throughput
max_wal_size = 8GB
min_wal_size = 2GB
wal_buffers = 128MB
checkpoint_completion_target = 0.9
checkpoint_timeout = 10min
synchronous_commit = off
wal_compression = on
wal_level = replica

# TimescaleDB Compression Settings
timescaledb.compress_segmentby_default = on
timescaledb.compress_orderby_default = on
timescaledb.enable_compression_wal_markers = on

# Parallel Processing for Analytics
max_parallel_workers = 16
max_parallel_workers_per_gather = 8
max_parallel_maintenance_workers = 4
force_parallel_mode = off
parallel_leader_participation = on

# Background Writer Optimizations
bgwriter_delay = 20ms
bgwriter_lru_maxpages = 2000
bgwriter_lru_multiplier = 10.0
bgwriter_flush_after = 512kB

# Query Planning for Time-Series
seq_page_cost = 1.0
random_page_cost = 1.0
cpu_tuple_cost = 0.01
cpu_index_tuple_cost = 0.005
effective_io_concurrency = 300
maintenance_io_concurrency = 10

# Autovacuum for Time-Series Data
autovacuum = on
autovacuum_max_workers = 6
autovacuum_naptime = 10s
autovacuum_vacuum_threshold = 100
autovacuum_analyze_threshold = 100
autovacuum_vacuum_scale_factor = 0.05
autovacuum_analyze_scale_factor = 0.02
autovacuum_vacuum_cost_delay = 5ms
autovacuum_vacuum_cost_limit = 2000

# Statistics Collection for Performance Monitoring
track_activities = on
track_counts = on
track_io_timing = on
track_functions = all
track_activity_query_size = 2048
pg_stat_statements.max = 20000
pg_stat_statements.track = all
pg_stat_statements.track_utility = on

# Logging for Analytics Performance
log_min_duration_statement = 500ms
log_checkpoints = on
log_lock_waits = on
log_temp_files = 5MB
log_autovacuum_min_duration = 2s

# Memory-Optimized Sort Settings
temp_buffers = 32MB
temp_file_limit = 10GB

# Connection and Security
listen_addresses = '*'
port = 5432
max_prepared_transactions = 200
password_encryption = scram-sha-256

# TimescaleDB Continuous Aggregates
timescaledb.enable_cagg_reorder_groupby = on
timescaledb.enable_chunk_append = on
timescaledb.enable_constraint_aware_append = on
timescaledb.enable_ordered_append = on
timescaledb.enable_skip_scan = on

# Replication for High Availability
hot_standby = on
hot_standby_feedback = on
max_standby_streaming_delay = 30s
wal_receiver_status_interval = 1s